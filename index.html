mostrarNotificacao('Erro ao carregar sistema. Recarregue a página.', 'error');
            }
        }

        // Aguardar DOM carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializar);
        } else {
            inicializar();
        }

        // Gerar número sequencial do documento
        function gerarNumeroDocumento() {
            try {
                const ano = new Date().getFullYear();
                const contador = localStorage.getItem('cas_contador_documentos') || '0';
                const novoContador = String(parseInt(contador) + 1).padStart(4, '0');
                numeroDocumento = `CAS-DF-${ano}-${novoContador}`;
                localStorage.setItem('cas_contador_documentos', novoContador);
            } catch (error) {
                console.error('Erro ao gerar número do documento:', error);
                numeroDocumento = `CAS-DF-${new Date().getFullYear()}-${Date.now()}`;
            }
        }

        // Aplicar máscaras com verificação segura
        function aplicarMascaras() {
            try {
                const cpfInput = document.getElementById('cpf_conselheiro');
                if (cpfInput) {
                    cpfInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                        e.target.value = value;
                    });
                }

                // NOVA MÁSCARA PARA CNPJ
                const cnpjInput = document.getElementById('cnpj_entidade');
                if (cnpjInput) {
                    cnpjInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                        value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                        value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                        value = value.replace(/(\d{4})(\d)/, '$1-$2');
                        e.target.value = value;
                    });
                }
            } catch (error) {
                console.error('Erro ao aplicar máscaras:', error);
            }
        }

        // Monitorar validações para habilitar/desabilitar botão de relatório
        function monitorarValidacoes() {
            try {
                const btnRelatorio = document.getElementById('btnRelatorio');
                const checkDeclaracao = document.getElementById('declaracao_veracidade');
                
                if (checkDeclaracao) {
                    checkDeclaracao.addEventListener('change', verificarLiberacaoRelatorio);
                }

                // Verificar periodicamente se pode liberar o relatório
                setInterval(verificarLiberacaoRelatorio, 1000);
            } catch (error) {
                console.error('Erro ao monitorar validações:', error);
            }
        }

        // Verificar se pode liberar geração de relatório
        function verificarLiberacaoRelatorio() {
            try {
                const btnRelatorio = document.getElementById('btnRelatorio');
                const checkDeclaracao = document.getElementById('declaracao_veracidade');
                
                if (!btnRelatorio || !checkDeclaracao) return;
                
                const declaracaoMarcada = checkDeclaracao.checked;
                
                if (declaracaoMarcada && assinaturaValida) {
                    btnRelatorio.disabled = false;
                    btnRelatorio.style.opacity = '1';
                    btnRelatorio.title = 'Clique para gerar o relatório';
                } else {
                    btnRelatorio.disabled = true;
                    btnRelatorio.style.opacity = '0.5';
                    if (!declaracaoMarcada) {
                        btnRelatorio.title = 'Marque a declaração de responsabilidade';
                    } else if (!assinaturaValida) {
                        btnRelatorio.title = 'Assine digitalmente o documento';
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar liberação do relatório:', error);
            }
        }

        // Validar CPF (algoritmo oficial)
        function validarCPF(cpf) {
            try {
                cpf = cpf.replace(/\D/g, '');
                if (cpf.length !== 11) return false;
                if (/^(\d)\1+$/.test(cpf)) return false; // CPF com todos os dígitos iguais
                
                let soma = 0;
                for (let i = 0; i < 9; i++) {
                    soma += parseInt(cpf.charAt(i)) * (10 - i);
                }
                let resto = 11 - (soma % 11);
                let dv1 = resto < 2 ? 0 : resto;
                
                if (parseInt(cpf.charAt(9)) !== dv1) return false;
                
                soma = 0;
                for (let i = 0; i < 10; i++) {
                    soma += parseInt(cpf.charAt(i)) * (11 - i);
                }
                resto = 11 - (soma % 11);
                let dv2 = resto < 2 ? 0 : resto;
                
                return parseInt(cpf.charAt(10)) === dv2;
            } catch (error) {
                console.error('Erro ao validar CPF:', error);
                return false;
            }
        }

        // NOVA FUNÇÃO: Validar CNPJ
        function validarCNPJ(cnpj) {
            try {
                cnpj = cnpj.replace(/\D/g, '');
                if (cnpj.length !== 14) return false;
                if (/^(\d)\1+$/.test(cnpj)) return false;
                
                // Validação do primeiro dígito
                let soma = 0;
                let peso = 2;
                for (let i = 11; i >= 0; i--) {
                    soma += parseInt(cnpj.charAt(i)) * peso;
                    peso = peso === 9 ? 2 : peso + 1;
                }
                let dv1 = soma % 11 < 2 ? 0 : 11 - (soma % 11);
                
                if (parseInt(cnpj.charAt(12)) !== dv1) return false;
                
                // Validação do segundo dígito
                soma = 0;
                peso = 2;
                for (let i = 12; i >= 0; i--) {
                    soma += parseInt(cnpj.charAt(i)) * peso;
                    peso = peso === 9 ? 2 : peso + 1;
                }
                let dv2 = soma % 11 < 2 ? 0 : 11 - (soma % 11);
                
                return parseInt(cnpj.charAt(13)) === dv2;
            } catch (error) {
                console.error('Erro ao validar CNPJ:', error);
                return false;
            }
        }

        // Gerar hash robusto do documento
        function gerarHashDocumento() {
            try {
                const form = document.getElementById('fiscalizacaoForm');
                if (!form) throw new Error('Formulário não encontrado');
                
                const formData = new FormData(form);
                const dados = Object.fromEntries(formData.entries());
                
                // Adicionar dados dos checkboxes
                const servicosSelecionados = Array.from(document.querySelectorAll('input[name="tipoServico"]:checked'))
                    .map(cb => cb.value);
                const formasAcesso = Array.from(document.querySelectorAll('input[name="formasAcesso"]:checked'))
                    .map(cb => cb.value);
                const especialidades = Array.from(document.querySelectorAll('input[name="especialidades"]:checked'))
                    .map(cb => cb.value);
                
                // Criar string de dados para hash
                const dadosString = JSON.stringify({
                    numeroDocumento,
                    ...dados,
                    tipoServico: servicosSelecionados,
                    formasAcesso: formasAcesso,
                    especialidades: especialidades,
                    timestamp: new Date().toISOString()
                });
                
                // Gerar hash usando btoa e manipulação de string
                let hash = '';
                for (let i = 0; i < dadosString.length; i++) {
                    hash += dadosString.charCodeAt(i).toString(16);
                }
                
                // Reduzir e formatar hash
                return btoa(hash).substring(0, 32).toUpperCase();
            } catch (error) {
                console.error('Erro ao gerar hash:', error);
                return 'HASH_ERROR_' + Date.now();
            }
        }

        // Gerar QR Code simples (texto)
        function gerarQRCode(texto) {
            try {
                const qrDiv = document.getElementById('qrcode');
                if (!qrDiv) return;
                
                qrDiv.innerHTML = `
                    <div style="font-family: monospace; font-size: 8px; line-height: 8px; letter-spacing: 0;">
                        ██████████████    ████  ██████████████<br>
                        ██          ██  ██  ██  ██          ██<br>
                        ██  ██████  ██    ██    ██  ██████  ██<br>
                        ██  ██████  ██  ██████  ██  ██████  ██<br>
                        ██  ██████  ██    ██    ██  ██████  ██<br>
                        ██          ██  ██  ██  ██          ██<br>
                        ██████████████  ██  ██  ██████████████<br>
                                      ██      ██<br>
                        ██████    ████████████    ██    ████<br>
                        ██    ████    ██    ████████  ██    <br>
                        ████████  ██████  ██    ██      ████<br>
                        ██  ████████    ████  ████████      <br>
                        ████    ██  ██████████    ██  ██████<br>
                                      ██    ██████    ████<br>
                        ██████████████    ██    ██  ██      <br>
                        ██          ██      ████████    ████<br>
                        ██  ██████  ██  ██████    ██████████<br>
                        ██  ██████  ██    ██████████    ██  <br>
                        ██  ██████  ██  ████  ██    ████████<br>
                        ██          ██    ████  ██████      <br>
                        ██████████████  ██████████  ████████<br>
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        Escaneie para verificar: ${texto.substring(0, 20)}...
                    </p>
                `;
            } catch (error) {
                console.error('Erro ao gerar QR Code:', error);
            }
        }

        // Assinatura digital aprimorada
        function assinarDigitalmente() {
            try {
                const cpf = document.getElementById('cpf_conselheiro')?.value;
                const cnpj = document.getElementById('cnpj_entidade')?.value; // NOVO: incluir CNPJ na validação
                const senha = document.getElementById('senha_assinatura')?.value;
                const conselheiro = document.getElementById('nome_conselheiro')?.value;
                const entidade = document.getElementById('nome_entidade')?.value; // NOVO: incluir nome da entidade
                const confirmaAssinatura = document.getElementById('confirma_assinatura')?.checked;
                
                // Validações ATUALIZADAS
                if (!cpf || !cnpj || !senha || !conselheiro || !entidade) {
                    mostrarNotificacao('Preencha todos os campos obrigatórios (incluindo nome da entidade e CNPJ)', 'error');
                    return;
                }
                
                if (!validarCPF(cpf)) {
                    mostrarNotificacao('CPF inválido. Verifique os números digitados.', 'error');
                    return;
                }

                // NOVA VALIDAÇÃO: CNPJ
                if (!validarCNPJ(cnpj)) {
                    mostrarNotificacao('CNPJ inválido. Verifique os números digitados.', 'error');
                    return;
                }
                
                if (senha.length < 6) {
                    mostrarNotificacao('Senha deve ter pelo menos 6 caracteres', 'error');
                    return;
                }
                
                if (!confirmaAssinatura) {
                    mostrarNotificacao('Confirme a autorização de assinatura digital', 'error');
                    return;
                }

                // Gerar assinatura digital
                const timestamp = new Date();
                const timestampFormatado = timestamp.toLocaleString('pt-BR', { 
                    timeZone: 'America/Sao_Paulo',
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                hashDocumento = gerarHashDocumento();
                
                // Salvar dados do relatório ATUALIZADO
                dadosRelatorio = {
                    numeroDocumento,
                    conselheiro,
                    cpf,
                    entidade,        // NOVO
                    cnpj,           // NOVO
                    timestamp: timestampFormatado,
                    hash: hashDocumento
                };
                
                // Exibir informações da assinatura
                const elements = {
                    signatoryName: document.getElementById('signatoryName'),
                    signatoryCPF: document.getElementById('signatoryCPF'),
                    signatureDateTime: document.getElementById('signatureDateTime'),
                    verificationHash: document.getElementById('verificationHash'),
                    signatureInfo: document.getElementById('signatureInfo')
                };
                
                if (elements.signatoryName) elements.signatoryName.textContent = conselheiro;
                if (elements.signatoryCPF) elements.signatoryCPF.textContent = cpf;
                if (elements.signatureDateTime) elements.signatureDateTime.textContent = timestampFormatado + ' (Brasília)';
                if (elements.verificationHash) elements.verificationHash.textContent = hashDocumento;
                if (elements.signatureInfo) elements.signatureInfo.style.display = 'block';
                
                // Limpar campos sensíveis
                const senhaEl = document.getElementById('senha_assinatura');
                if (senhaEl) senhaEl.value = '';
                
                // Marcar como válida
                assinaturaValida = true;
                
                // Desabilitar campos de assinatura ATUALIZADO
                const cpfEl = document.getElementById('cpf_conselheiro');
                const cnpjEl = document.getElementById('cnpj_entidade'); // NOVO
                const confirmaEl = document.getElementById('confirma_assinatura');
                if (cpfEl) cpfEl.setAttribute('readonly', true);
                if (cnpjEl) cnpjEl.setAttribute('readonly', true); // NOVO
                if (confirmaEl) confirmaEl.disabled = true;
                
                verificarLiberacaoRelatorio();
                
                mostrarNotificacao('Documento assinado digitalmente com sucesso!', 'success');
            } catch (error) {
                console.error('Erro na assinatura digital:', error);
                mostrarNotificacao('Erro ao assinar documento. Tente novamente.', 'error');
            }
        }

        // Validar formulário ATUALIZADO
        function validarFormulario() {
            try {
                const camposObrigatorios = [
                    'nome_entidade', 'cnpj_entidade', 'data_visita', // NOVOS CAMPOS INCLUÍDOS
                    'nome_recebeu', 'funcao_recebeu', 'nome_conselheiro'
                ];

                let erros = [];

                // Validar campos básicos
                camposObrigatorios.forEach(campo => {
                    const elemento = document.getElementById(campo);
                    if (!elemento || !elemento.value.trim()) {
                        const label = elemento?.parentElement?.querySelector('label')?.textContent || campo;
                        erros.push(`Campo "${label}" é obrigatório`);
                    }
                });

                // NOVA VALIDAÇÃO: Verificar CNPJ
                const cnpj = document.getElementById('cnpj_entidade')?.value;
                if (cnpj && !validarCNPJ(cnpj)) {
                    erros.push('CNPJ inválido');
                }

                // Verificar serviços selecionados
                const servicosSelecionados = document.querySelectorAll('input[name="tipoServico"]:checked');
                if (servicosSelecionados.length === 0) {
                    erros.push('Selecione pelo menos um tipo de serviço');
                }

                // Verificar horário da visita
                const horarioSelecionado = document.querySelector('input[name="horario_visita"]:checked');
                if (!horarioSelecionado) {
                    erros.push('Selecione o horário da visita');
                }

                // Verificar declaração de responsabilidade
                const declaracaoMarcada = document.getElementById('declaracao_veracidade')?.checked;
                if (!declaracaoMarcada) {
                    erros.push('Marque a declaração de responsabilidade');
                }

                // Verificar assinatura digital
                if (!assinaturaValida) {
                    erros.push('Assine digitalmente o documento');
                }

                if (erros.length > 0) {
                    mostrarNotificacao(`Erros encontrados:\n${erros.join('\n')}`, 'error');
                    return false;
                }

                mostrarNotificacao('Formulário válido e pronto para gerar relatório! ✅', 'success');
                return true;
            } catch (error) {
                console.error('Erro na validação:', error);
                mostrarNotificacao('Erro ao validar formulário.', 'error');
                return false;
            }
        }

        // Gerar relatório ATUALIZADO
        function gerarRelatorio() {
            try {
                // Verificações finais de segurança
                const declaracaoEl = document.getElementById('declaracao_veracidade');
                if (!declaracaoEl?.checked) {
                    mostrarNotificacao('Marque a declaração de responsabilidade antes de gerar o relatório', 'error');
                    return;
                }

                if (!assinaturaValida) {
                    mostrarNotificacao('Assine digitalmente o documento antes de gerar o relatório', 'error');
                    return;
                }

                if (!validarFormulario()) {
                    return;
                }

                const form = document.getElementById('fiscalizacaoForm');
                if (!form) throw new Error('Formulário não encontrado');

                const formData = new FormData(form);
                const dados = Object.fromEntries(formData.entries());

                // Obter dados dos checkboxes
                const servicosSelecionados = Array.from(document.querySelectorAll('input[name="tipoServico"]:checked'))
                    .map(cb => cb.value);
                const formasAcesso = Array.from(document.querySelectorAll('input[name="formasAcesso"]:checked'))
                    .map(cb => cb.value);
                const especialidades = Array.from(document.querySelectorAll('input[name="especialidades"]:checked'))
                    .map(cb => cb.value);

                let relatorio = `
                    <div style="page-break-after: always;">
                        <p style="text-align: center; margin-bottom: 30px;"><strong>Seja o presente voto submetido à deliberação da plenária.</strong></p>
                        
                        <h3>ESTE VOTO ANALISARÁ O SEGUINTE SERVIÇO:</h3>
                        <ul>
                            ${servicosSelecionados.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                        
                        <h3>1. DOCUMENTOS DISPONIBILIZADOS:</h3>
                        <p><strong>Parecer(s) Técnico(s) nº:</strong> ${dados.pareceres_tecnicos || '_'.repeat(50)}</p>
                        <p><strong>Nota(s) Técnica(s) nº:</strong> ${dados.notas_tecnicas || '_'.repeat(50)}</p>
                        <p><strong>Plano de Ação Ano:</strong> ${dados.plano_acao_ano || '____'} &nbsp;&nbsp;&nbsp; <strong>Relatório de Atividades Ano:</strong> ${dados.relatorio_atividades_ano || '____'}</p>
                        
                        <h3>2. DA VISITA</h3>
                        <p><strong>Nome da Entidade Visitada:</strong> ${dados.nome_entidade || '____'}</p>
                        <p><strong>CNPJ:</strong> ${dados.cnpj_entidade || '____'}</p>
                        <p><strong>2.1. Data:</strong> ${dados.data_visita ? new Date(dados.data_visita).toLocaleDateString('pt-BR') : '____'}</p>
                        <p><strong>2.2. Horário:</strong> ${dados.horario_visita === 'matutino' ? '☑ matutino ☐ vespertino' : '☐ matutino ☑ vespertino'}</p>
                        <p><strong>2.3. Nome de quem recebeu o conselheiro na instituição:</strong> ${dados.nome_recebeu || '____'}<br>
                        <strong>Função:</strong> ${dados.funcao_recebeu || '____'}</p>
                        
                        <h4>2.4. Endereço(s) visitado(s):</h4>
                        ${dados.endereco_1 ? `<p><strong>1:</strong> ${dados.endereco_1} - Licença de Funcionamento: ${dados.licenca_1 === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>` : ''}
                        ${dados.endereco_2 ? `<p><strong>2:</strong> ${dados.endereco_2} - Licença de Funcionamento: ${dados.licenca_2 === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>` : ''}
                        ${dados.endereco_3 ? `<p><strong>3:</strong> ${dados.endereco_3} - Licença de Funcionamento: ${dados.licenca_3 === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>` : ''}
                        
                        <h4>2.5. Público-alvo:</h4>
                        <table border="1" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr>
                                <th>Público</th>
                                <th>CDI/DF</th>
                                <th>CDCA/DF</th>
                            </tr>
                            <tr>
                                <td>Pessoas idosas (mais de 60 anos)</td>
                                <td>${dados.cdi_idosos === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</td>
                                <td>não se aplica</td>
                            </tr>
                            <tr>
                                <td>Crianças e adolescentes (até 18 anos)</td>
                                <td>não se aplica</td>
                                <td>${dados.cdca_criancas === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</td>
                            </tr>
                            <tr>
                                <td>Famílias</td>
                                <td>${dados.cdi_familias === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</td>
                                <td>${dados.cdca_familias === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</td>
                            </tr>
                            <tr>
                                <td>Adultos (entre 18 a 59 anos)</td>
                                <td>não se aplica</td>
                                <td>não se aplica</td>
                            </tr>
                        </table>
                        
                        <h4>2.6. Formas de acesso dos usuários nos serviços/ações:</h4>
                        <ul>
                            ${formasAcesso.map(forma => `<li>☑ ${forma}</li>`).join('')}
                            ${dados.outras_formas ? `<li>☑ Outros: ${dados.outras_formas}</li>` : ''}
                        </ul>
                        
                        <h4>2.7. Equipe de profissionais:</h4>
                        <p><strong>Nº de voluntários:</strong> ${dados.num_voluntarios || '____'} &nbsp;&nbsp;&nbsp; <strong>Nº de contratados:</strong> ${dados.num_contratados || '____'}</p>
                        
                        <h4>2.8. Especialidades que atuam na oferta socioassistencial:</h4>
                        <ul>
                            ${especialidades.map(esp => `<li>☑ ${esp}</li>`).join('')}
                            ${dados.outras_especialidades ? `<li>☑ outros: ${dados.outras_especialidades}</li>` : ''}
                        </ul>
                        
                        <h4>2.9. Infraestrutura:</h4>
                        <p><strong>a) O Espaço é:</strong> ${dados.tipo_espaco === 'próprio' ? '☑ próprio' : '☐ próprio'} ${dados.tipo_espaco === 'alugado' ? '☑ alugado' : '☐ alugado'} ${dados.tipo_espaco === 'cedido' ? '☑ cedido' : '☐ cedido'}</p>
                        <p><strong>b) Atende aos critérios de acessibilidade?</strong> ${dados.acessibilidade === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>
                        ${dados.obs_acessibilidade ? `<p><strong>Observações:</strong> ${dados.obs_acessibilidade}</p>` : ''}
                        <p><strong>c) Compartilha o espaço com outros serviços?</strong> ${dados.compartilha_espaco === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>
                        ${dados.obs_compartilhamento ? `<p><strong>Observações:</strong> ${dados.obs_compartilhamento}</p>` : ''}
                        <p><strong>d) O espaço atende de forma satisfatória a execução da oferta socioassistencial?</strong> ${dados.espaco_satisfatorio === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>
                        ${dados.obs_espaco ? `<p><strong>Observações:</strong> ${dados.obs_espaco}</p>` : ''}
                        
                        <h4>2.10. Do caráter contínuo e permanente:</h4>
                        <p><strong>a) Possui atividades de Dezembro a Dezembro?</strong> ${dados.atividades_continuas === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>
                        <p><strong>b) Possui recesso/férias coletivas?</strong> ${dados.recesso_ferias === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>
                        
                        <h4>2.11. As ações ofertadas são totalmente gratuitas?</h4>
                        <p>${dados.acoes_gratuitas === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>
                        ${dados.especificar_nao_gratuitas ? `<p><strong>Especifique:</strong> ${dados.especificar_nao_gratuitas}</p>` : ''}
                        ${dados.especificar_bpc ? `<p><strong>Recebe BPC. Especifique:</strong> ${dados.especificar_bpc}</p>` : ''}
                        
                        <h4>2.12. Articulação com a rede setorial SUAS e outras redes:</h4>
                        <table border="1" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr><th>Rede</th><th>Sim</th><th>Não</th><th>Observações</th></tr>
                            <tr><td>CRAS</td><td>${dados.articulacao_cras === 'sim' ? '☑' : '☐'}</td><td>${dados.articulacao_cras === 'nao' ? '☑' : '☐'}</td><td>${dados.obs_cras || ''}</td></tr>
                            <tr><td>CREAS</td><td>${dados.articulacao_creas === 'sim' ? '☑' : '☐'}</td><td>${dados.articulacao_creas === 'nao' ? '☑' : '☐'}</td><td>${dados.obs_creas || ''}</td></tr>
                            <tr><td>Saúde</td><td>${dados.articulacao_saude === 'sim' ? '☑' : '☐'}</td><td>${dados.articulacao_saude === 'nao' ? '☑' : '☐'}</td><td>${dados.obs_saude || ''}</td></tr>
                            <tr><td>Educação</td><td>${dados.articulacao_educacao === 'sim' ? '☑' : '☐'}</td><td>${dados.articulacao_educacao === 'nao' ? '☑' : '☐'}</td><td>${dados.obs_educacao || ''}</td></tr>
                            <tr><td>Habitação</td><td>${dados.articulacao_habitacao === 'sim' ? '☑' : '☐'}</td><td>${dados.articulacao_habitacao === 'nao' ? '☑' : '☐'}</td><td>${dados.obs_habitacao || ''}</td></tr>
                            <tr><td>Trabalho e Renda</td><td>${dados.articulacao_trabalho === 'sim' ? '☑' : '☐'}</td><td>${dados.articulacao_trabalho === 'nao' ? '☑' : '☐'}</td><td>${dados.obs_trabalho || ''}</td></tr>
                            <tr><td>Sistema de Justiça</td><td>${dados.articulacao_justica === 'sim' ? '☑' : '☐'}</td><td>${dados.articulacao_justica === 'nao' ? '☑' : '☐'}</td><td>${dados.obs_justica || ''}</td></tr>
                        </table>
                        
                        <h4>2.13. As ações efetivamente executadas correspondem à oferta para a qual possui inscrição?</h4>
                        <p>${dados.acoes_correspondem === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>
                        ${dados.obs_acoes_correspondem ? `<p><strong>Observações:</strong> ${dados.obs_acoes_correspondem}</p>` : ''}
                        
                        <h4>2.14. A forma de execução (metodologia) das ações atende às diretrizes das regulamentações?</h4>
                        <p>${dados.metodologia_adequada === 'sim' ? '☑ sim ☐ não' : '☐ sim ☑ não'}</p>
                        ${dados.obs_metodologia ? `<p><strong>Observações:</strong> ${dados.obs_metodologia}</p>` : ''}
                        
                        <h3>3. DO VOTO</h3>
                        <p><strong>3.1. Quanto às análises técnicas elaboradas pela Secretaria Executiva, o Relator:</strong></p>
                        <p>${dados.concordancia_analises === 'concorda' ? '☑ concorda ☐ discorda' : '☐ concorda ☑ discorda'}</p>
                        ${dados.fundamentos_discordancia ? `<p><strong>Fundamentos:</strong> ${dados.fundamentos_discordancia}</p>` : ''}
                        
                        <p><strong>3.2. O(A) Conselheiro(a) vota pelo(a):</strong></p>
                        <p>${dados.voto_final === 'Indeferimento do pedido quanto à oferta analisada' ? '☑' : '☐'} Indeferimento do pedido quanto à oferta analisada</p>
                        <p>${dados.voto_final === 'Deferimento do pedido quanto à oferta analisada' ? '☑' : '☐'} Deferimento do pedido quanto à oferta analisada</p>
                        <p>${dados.voto_final === 'Manutenção da inscrição quanto à oferta analisada' ? '☑' : '☐'} Manutenção da inscrição quanto à oferta analisada</p>
                        <p>${dados.voto_final === 'Cancelamento da inscrição quanto à oferta analisada' ? '☑' : '☐'} Cancelamento da inscrição quanto à oferta analisada</p>
                        
                        <div style="margin-top: 40px; padding: 20px; border: 2px solid #48bb78; border-radius: 10px; background: #f0fff4;">
                            <h4 style="color: #38a169;">✅ DOCUMENTO OFICIAL CAS-DF</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 12px; margin: 15px 0;">
                                <p><strong>Número do Documento:</strong> ${numeroDocumento}</p>
                                <p><strong>Data/Hora de Assinatura:</strong> ${document.getElementById('signatureDateTime')?.textContent || 'N/A'}</p>
                                <p><strong>Conselheiro Responsável:</strong> ${dados.nome_conselheiro}</p>
                                <p><strong>CPF:</strong> ${dados.cpf_conselheiro}</p>
                                <p><strong>Entidade Fiscalizada:</strong> ${dados.nome_entidade}</p>
                                <p><strong>CNPJ:</strong> ${dados.cnpj_entidade}</p>
                            </div>
                            <p style="font-size: 11px; margin: 10px 0;"><strong>Hash de Verificação:</strong> ${hashDocumento}</p>
                            <p style="font-size: 10px; color: #666; margin: 10px 0; text-align: center;">
                                Este documento foi assinado digitalmente e possui validade legal conforme MP 2.200-2/2001
                            </p>
                        </div>
                        
                        <div style="margin-top: 40px;">
                            <p><strong>Seja o presente voto submetido à deliberação da plenária.</strong></p>
                            <p style="margin-top: 30px;">${dados.data_voto ? new Date(dados.data_voto).toLocaleDateString('pt-BR') : '____'}</p>
                            <div style="margin-top: 50px; border-top: 1px solid black; width: 300px; text-align: center;">
                                <p>${dados.nome_conselheiro}</p>
                                <p>Conselheiro(a)</p>
                            </div>
                        </div>
                    </div>
                `;

                const reportContentEl = document.getElementById('reportContent');
                const reportSectionEl = document.getElementById('reportSection');
                const formEl = document.getElementById('fiscalizacaoForm');

                if (reportContentEl) reportContentEl.innerHTML = relatorio;
                if (reportSectionEl) reportSectionEl.style.display = 'block';
                if (formEl) formEl.style.display = 'none';
                
                // Scroll para o topo do relatório
                if (reportSectionEl) {
                    reportSectionEl.scrollIntoView({ behavior: 'smooth' });
                }

                mostrarNotificacao('Relatório gerado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                mostrarNotificacao('Erro ao gerar relatório. Tente novamente.', 'error');
            }
        }

        // Salvar rascunho
        function salvarRascunho() {
            try {
                const form = document.getElementById('fiscalizacaoForm');
                if (!form) throw new Error('Formulário não encontrado');

                const formData = new FormData(form);
                const dados = Object.fromEntries(formData.entries());
                
                // Adicionar dados dos checkboxes múltiplos
                const servicosSelecionados = Array.from(document.querySelectorAll('input[name="tipoServico"]:checked'))
                    .map(cb => cb.value);
                dados.tipoServico = servicosSelecionados;
                
                const formasAcesso = Array.from(document.querySelectorAll('input[name="formasAcesso"]:checked'))
                    .map(cb => cb.value);
                dados.formasAcesso = formasAcesso;
                
                const especialidades = Array.from(document.querySelectorAll('input[name="especialidades"]:checked'))
                    .map(cb => cb.value);
                dados.especialidades = especialidades;
                
                // Salvar estado da assinatura (mas não os dados sensíveis)
                dados.assinaturaValida = assinaturaValida;
                dados.hashDocumento = hashDocumento;
                
                // Salvar no localStorage
                localStorage.setItem('cas_rascunho', JSON.stringify(dados));
                localStorage.setItem('cas_rascunho_data', new Date().toISOString());
                
                mostrarNotificacao('Rascunho salvo com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar rascunho:', error);
                mostrarNotificacao('Erro ao salvar rascunho.', 'error');
            }
        }

        // Carregar rascunho
        function carregarRascunho() {
            try {
                const rascunho = localStorage.getItem('cas_rascunho');
                
                if (!rascunho) {
                    mostrarNotificacao('Nenhum rascunho encontrado', 'error');
                    return;
                }

                const dados = JSON.parse(rascunho);
                
                // Preencher campos de texto e radios
                Object.keys(dados).forEach(key => {
                    if (Array.isArray(dados[key]) || key === 'assinaturaValida' || key === 'hashDocumento') return;
                    
                    const elemento = document.querySelector(`[name="${key}"]`);
                    if (elemento) {
                        if (elemento.type === 'radio') {
                            const radio = document.querySelector(`[name="${key}"][value="${dados[key]}"]`);
                            if (radio) radio.checked = true;
                        } else if (elemento.type === 'checkbox' && key !== 'declaracao_veracidade' && key !== 'confirma_assinatura') {
                            // Não recarregar checkboxes de declaração por segurança
                            elemento.checked = dados[key] === 'on';
                        } else {
                            elemento.value = dados[key];
                        }
                    }
                });

                // Preencher checkboxes de arrays
                if (dados.tipoServico && Array.isArray(dados.tipoServico)) {
                    dados.tipoServico.forEach(valor => {
                        const checkbox = document.querySelector(`[name="tipoServico"][value="${valor}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                if (dados.formasAcesso && Array.isArray(dados.formasAcesso)) {
                    dados.formasAcesso.forEach(valor => {
                        const checkbox = document.querySelector(`[name="formasAcesso"][value="${valor}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                if (dados.especialidades && Array.isArray(dados.especialidades)) {
                    dados.especialidades.forEach(valor => {
                        const checkbox = document.querySelector(`[name="especialidades"][value="${valor}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // IMPORTANTE: NÃO recarregar assinatura por segurança
                // Usuário deve assinar novamente

                const dataRascunho = localStorage.getItem('cas_rascunho_data');
                const dataFormatada = new Date(dataRascunho).toLocaleString();
                
                mostrarNotificacao(`Rascunho carregado! (salvo em ${dataFormatada})\n⚠️ Por segurança, você deve assinar novamente o documento.`, 'info');
            } catch (error) {
                console.error('Erro ao carregar rascunho:', error);
                mostrarNotificacao('Erro ao carregar rascunho', 'error');
            }
        }

        // Limpar formulário
        function limparFormulario() {
            try {
                if (confirm('Tem certeza que deseja limpar todos os dados? Esta ação não pode ser desfeita.')) {
                    const form = document.getElementById('fiscalizacaoForm');
                    if (form) form.reset();
                    
                    // Resetar estados de assinatura
                    assinaturaValida = false;
                    hashDocumento = '';
                    
                    const signatureInfo = document.getElementById('signatureInfo');
                    const cpfEl = document.getElementById('cpf_conselheiro');
                    const cnpjEl = document.getElementById('cnpj_entidade'); // NOVO
                    const confirmaEl = document.getElementById('confirma_assinatura');
                    
                    if (signatureInfo) signatureInfo.style.display = 'none';
                    if (cpfEl) cpfEl.removeAttribute('readonly');
                    if (cnpjEl) cnpjEl.removeAttribute('readonly'); // NOVO
                    if (confirmaEl) confirmaEl.disabled = false;
                    
                    // Limpar rascunho salvo
                    localStorage.removeItem('cas_rascunho');
                    localStorage.removeItem('cas_rascunho_data');
                    
                    verificarLiberacaoRelatorio();
                    
                    mostrarNotificacao('Formulário limpo com sucesso!', 'info');
                }
            } catch (error) {
                console.error('Erro ao limpar formulário:', error);
                mostrarNotificacao('Erro ao limpar formulário.', 'error');
            }
        }

        // Gerar PDF otimizado
        function gerarPDF() {
            try {
                const conteudoImpressao = `
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Relatório CAS-DF - ${numeroDocumento}</title>
                        <style>
                            @media print {
                                @page { 
                                    margin: 2cm; 
                                    size: A4;
                                }
                                body { 
                                    font-family: Arial, sans-serif; 
                                    font-size: 11px; 
                                    line-height: 1.3;
                                    color: black;
                                    background: white;
                                }
                                table { 
                                    border-collapse: collapse; 
                                    width: 100%; 
                                    page-break-inside: avoid;
                                }
                                th, td { 
                                    border: 1px solid #000; 
                                    padding: 4px; 
                                    font-size: 10px;
                                }
                                h3, h4 { 
                                    color: #000; 
                                    page-break-after: avoid;
                                    margin-top: 15px;
                                    margin-bottom: 8px;
                                }
                                .no-print { display: none !important; }
                                .page-break { page-break-before: always; }
                            }
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                line-height: 1.4; 
                            }
                            table { border-collapse: collapse; width: 100%; margin: 10px 0; }
                            th, td { border: 1px solid #000; padding: 6px; text-align: left; }
                            th { background-color: #f0f0f0; font-weight: bold; }
                            h3, h4 { color: #2d3748; margin-top: 20px; margin-bottom: 10px; }
                            p { margin: 6px 0; }
                            .header-oficial { 
                                text-align: center; 
                                margin-bottom: 30px; 
                                border-bottom: 2px solid #000;
                                padding-bottom: 15px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header-oficial">
                            <h1>CONSELHO DE ASSISTÊNCIA SOCIAL DO DISTRITO FEDERAL</h1>
                            <p>SEPN Quadra 515 Lote 02 Bloco B, 4º andar - Asa Norte/DF - CEP 70.770-502</p>
                            <p>E-mail: Cas_df@sedes.df.gov.br</p>
                            <h2>FICHA DE RELATO DE FISCALIZAÇÃO</h2>
                            <p><strong>Documento Nº: ${numeroDocumento}</strong></p>
                        </div>
                        ${document.getElementById('reportContent')?.innerHTML || ''}
                    </body>
                    </html>
                `;
                
                // Criar nova janela para impressão
                const janelaImpressao = window.open('', '_blank');
                if (janelaImpressao) {
                    janelaImpressao.document.write(conteudoImpressao);
                    janelaImpressao.document.close();
                    
                    // Aguardar carregamento e iniciar download PDF
                    setTimeout(() => {
                        janelaImpressao.print();
                        janelaImpressao.close();
                    }, 500);
                }
                
                mostrarNotificacao('📄 PDF gerado! Use Ctrl+P para salvar como PDF', 'success');
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                mostrarNotificacao('Erro ao gerar PDF.', 'error');
            }
        }

        // Preparar dados para email
        function prepararEmail() {
            try {
                const form = document.getElementById('fiscalizacaoForm');
                if (!form) throw new Error('Formulário não encontrado');

                const formData = new FormData(form);
                const dados = Object.fromEntries(formData.entries());
                
                const nomeEntidade = dados.nome_entidade || 'Entidade não informada';
                const dataVisita = dados.data_visita ? new Date(dados.data_visita).toLocaleDateString('pt-BR') : '____';
                const conselheiro = dados.nome_conselheiro || '____';
                
                const assunto = `[CAS-DF] Relatório de Fiscalização - ${nomeEntidade} - Doc: ${numeroDocumento}`;
                
                const corpo = `Prezados colegas da Secretaria Executiva do CAS-DF,

Segue anexo o Relatório de Fiscalização devidamente preenchido e assinado digitalmente.

📋 DADOS DO RELATÓRIO:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• Número do Documento: ${numeroDocumento}
• Entidade Fiscalizada: ${nomeEntidade}
• CNPJ: ${dados.cnpj_entidade || 'N/A'}
• Data da Visita: ${dataVisita}
• Conselheiro Responsável: ${conselheiro}
• Data/Hora da Assinatura: ${document.getElementById('signatureDateTime')?.textContent || 'N/A'}
• Hash de Verificação: ${hashDocumento}

🔒 AUTENTICIDADE:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Este documento foi assinado digitalmente pelo conselheiro responsável e possui validade legal conforme MP 2.200-2/2001.

O conselheiro declarou sob responsabilidade legal a veracidade de todas as informações prestadas, estando ciente das penalidades previstas no Art. 299 do Código Penal.

📎 ANEXO:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• Relatório completo em formato PDF
• Documento oficial com assinatura digital integrada

Para verificar a autenticidade do documento, utilize o hash de verificação informado acima.

Atenciosamente,

${conselheiro}
Conselheiro(a) do CAS-DF
Sistema de Fiscalização Digital CAS-DF v2.0

▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
Este email foi gerado automaticamente pelo Sistema CAS-DF
CONSELHO DE ASSISTÊNCIA SOCIAL DO DISTRITO FEDERAL
SEPN Quadra 515 Lote 02 Bloco B, 4º andar - Asa Norte/DF`;

                return {
                    assunto,
                    corpo,
                    nomeArquivo: `Relatorio_CAS_${numeroDocumento}_${nomeEntidade.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`
                };
            } catch (error) {
                console.error('Erro ao preparar email:', error);
                return {
                    assunto: 'Erro ao preparar email',
                    corpo: 'Erro ao preparar dados do email.',
                    nomeArquivo: 'relatorio_erro.pdf'
                };
            }
        }

        // Funções de modal e utilitários
        function voltarFormulario() {
            try {
                const reportSectionEl = document.getElementById('reportSection');
                const formEl = document.getElementById('fiscalizacaoForm');

                if (reportSectionEl) reportSectionEl.style.display = 'none';
                if (formEl) formEl.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Erro ao voltar ao formulário:', error);
            }
        }

        function exportarHTML() {
            try {
                const htmlCompleto = document.documentElement.outerHTML;
                const blob = new Blob([htmlCompleto], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sistema_cas_completo_${new Date().toISOString().split('T')[0]}.html`;
                a.click();
                URL.revokeObjectURL(url);
                
                mostrarNotificacao('📥 Sistema completo exportado!', 'success');
            } catch (error) {
                console.error('Erro ao exportar HTML:', error);
                mostrarNotificacao('Erro ao exportar sistema.', 'error');
            }
        }

        function imprimirRelatorio() {
            try {
                mostrarNotificacao('🖨️ Abrindo janela de impressão para PDF...', 'info');
                setTimeout(() => {
                    window.print();
                }, 500);
            } catch (error) {
                console.error('Erro ao imprimir:', error);
                mostrarNotificacao('Erro ao imprimir.', 'error');
            }
        }

        // Funções simplificadas para modais
        function enviarEmail() { mostrarNotificacao('📧 Funcionalidade em desenvolvimento', 'info'); }
        function verificarDocumento() { mostrarNotificacao('🔍 Funcionalidade em desenvolvimento', 'info'); }
        function fecharEmailModal() { const modal = document.getElementById('emailModal'); if (modal) modal.style.display = 'none'; }
        function fecharVerificacaoModal() { const modal = document.getElementById('verificacaoModal'); if (modal) modal.style.display = 'none'; }
        function salvarRelatorio() { mostrarNotificacao('💾 Funcionalidade em desenvolvimento', 'info'); }
        function abrirClienteEmail() { mostrarNotificacao('📧 Funcionalidade em desenvolvimento', 'info'); }
        function copiarTextoEmail() { mostrarNotificacao('📋 Funcionalidade em desenvolvimento', 'info'); }

        // Sistema de notificações aprimorado
        function mostrarNotificacao(mensagem, tipo = 'info', duracao = 4000) {
            try {
                const notification = document.getElementById('notification');
                if (!notification) return;
                
                // Adicionar ícones por tipo
                const icones = {
                    'success': '✅',
                    'error': '❌', 
                    'info': 'ℹ️',
                    'warning': '⚠️'
                };
                
                const icone = icones[tipo] || 'ℹ️';
                notification.innerHTML = `${icone} ${mensagem}`;
                notification.className = `notification ${tipo}`;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duracao);
            } catch (error) {
                console.error('Erro ao mostrar notificação:', error);
            }
        }

        // Fechar modais clicando fora
        window.onclick = function(event) {
            try {
                const emailModal = document.getElementById('emailModal');
                const verificacaoModal = document.getElementById('verificacaoModal');
                
                if (event.target === emailModal) {
                    fecharEmailModal();
                }
                if (event.target === verificacaoModal) {
                    fecharVerificacaoModal();
                }
            } catch (error) {
                console.error('Erro ao fechar modal:', error);
            }
        }

        // Auto-save aprimorado (a cada 2 minutos)
        setInterval(() => {
            try {
                const nomeConselheiroEl = document.getElementById('nome_conselheiro');
                if (nomeConselheiroEl && nomeConselheiroEl.value.trim()) {
                    salvarRascunho();
                    mostrarNotificacao('💾 Auto-save realizado', 'info', 2000);
                }
            } catch (error) {
                console.error('Erro no auto-save:', error);
            }
        }, 120000); // 2 minutos

        // Detectar tentativa de sair da página
        window.addEventListener('beforeunload', function(event) {
            try {
                const nomeConselheiroEl = document.getElementById('nome_conselheiro');
                if (nomeConselheiroEl && nomeConselheiroEl.value.trim() && !assinaturaValida) {
                    event.preventDefault();
                    event.returnValue = 'Você tem dados não salvos. Deseja realmente sair?';
                    return 'Você tem dados não salvos. Deseja realmente sair?';
                }
            } catch (error) {
                console.error('Erro ao verificar saída:', error);
            }
        });

        // Atalhos de teclado
        document.addEventListener('keydown', function(event) {
            try {
                // Ctrl+S = Salvar rascunho
                if (event.ctrlKey && event.key === 's') {
                    event.preventDefault();
                    salvarRascunho();
                }
                
                // Ctrl+P = Gerar PDF (se relatório estiver aberto)
                if (event.ctrlKey && event.key === 'p') {
                    const reportSection = document.getElementById('reportSection');
                    if (reportSection && reportSection.style.display !== 'none') {
                        event.preventDefault();
                        gerarPDF();
                    }
                }
                
                // Escape = Fechar modais
                if (event.key === 'Escape') {
                    fecharEmailModal();
                    fecharVerificacaoModal();
                }
            } catch (error) {
                console.error('Erro nos atalhos de teclado:', error);
            }
        });
    </script>
</body>
</html> <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fiscalização CAS-DF - Versão Corrigida</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .content {
            padding: 40px;
        }

        .form-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            background: #f8fafc;
        }

        .form-section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
        }

        .checkbox-item input[type="checkbox"], .checkbox-item input[type="radio"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        .form-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        .form-table th,
        .form-table td {
            border: 1px solid #e2e8f0;
            padding: 12px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .form-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        .form-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .endereco-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            padding: 15px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
        }

        .articulacao-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin: 5px 0;
            background: white;
        }

        .articulacao-header {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close:hover {
            color: #000;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .checkbox-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            .articulacao-grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
        }

        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; border-radius: 0; }
            .action-buttons, .btn { display: none !important; }
            .form-section { break-inside: avoid; page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏛️ CONSELHO DE ASSISTÊNCIA SOCIAL DO DISTRITO FEDERAL</h1>
            <p>SEPN Quadra 515 Lote 02 Bloco B, 4º andar - Asa Norte/DF - CEP 70.770-502</p>
            <p>E-mail: Cas_df@sedes.df.gov.br</p>
        </div>

        <div class="content">
            <form id="fiscalizacaoForm">
                <!-- Este voto analisará o seguinte serviço -->
                <div class="form-section">
                    <h3>📋 Este voto analisará o seguinte serviço:</h3>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="acoes_assessoramento" name="tipoServico" value="1. Ações de Assessoramento">
                            <label for="acoes_assessoramento">1. Ações de Assessoramento</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="acoes_defesa" name="tipoServico" value="2. Ações de Defesa e Garantia de Direitos">
                            <label for="acoes_defesa">2. Ações de Defesa e Garantia de Direitos</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="promocao_integracao" name="tipoServico" value="3. Promoção da integração ao mundo do trabalho">
                            <label for="promocao_integracao">3. Promoção da integração ao mundo do trabalho</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servico_convivencia" name="tipoServico" value="4. Serviço de Convivência e Fortalecimento de Vínculos para crianças e adolescentes">
                            <label for="servico_convivencia">4. Serviço de Convivência e Fortalecimento de Vínculos para crianças e adolescentes</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servico_convivencia_jovens" name="tipoServico" value="4. Serviço de Convivência e Fortalecimento de Vínculos para jovens e adultos">
                            <label for="servico_convivencia_jovens">4. Serviço de Convivência e Fortalecimento de Vínculos para jovens e adultos</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servico_convivencia_idosos" name="tipoServico" value="4. Serviço de Convivência e Fortalecimento de Vínculos para pessoas idosas">
                            <label for="servico_convivencia_idosos">4. Serviço de Convivência e Fortalecimento de Vínculos para pessoas idosas</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="acoes_integracao_deficiencia" name="tipoServico" value="5. Ações de integração à vida comunitária da pessoa com deficiência">
                            <label for="acoes_integracao_deficiencia">5. Ações de integração à vida comunitária da pessoa com deficiência</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="protecao_basica_deficientes" name="tipoServico" value="6. Serviço de Proteção Social Básica no domicílio para pessoas com deficiência">
                            <label for="protecao_basica_deficientes">6. Serviço de Proteção Social Básica no domicílio para pessoas com deficiência</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="protecao_basica_idosos" name="tipoServico" value="6. Serviço de Proteção Social Básica no domicílio para pessoas idosas">
                            <label for="protecao_basica_idosos">6. Serviço de Proteção Social Básica no domicílio para pessoas idosas</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="protecao_especial_deficientes" name="tipoServico" value="7. Serviço de Proteção Social Especial para pessoas com deficiência e suas famílias">
                            <label for="protecao_especial_deficientes">7. Serviço de Proteção Social Especial para pessoas com deficiência e suas famílias</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="protecao_especial_idosos" name="tipoServico" value="7. Serviço de Proteção Social Especial para pessoas idosas e suas famílias">
                            <label for="protecao_especial_idosos">7. Serviço de Proteção Social Especial para pessoas idosas e suas famílias</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="abordagem_social" name="tipoServico" value="8. Serviço de Abordagem Social">
                            <label for="abordagem_social">8. Serviço de Abordagem Social</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="acolhimento_abrigo" name="tipoServico" value="9. Serviço de Acolhimento na modalidade Abrigo Institucional">
                            <label for="acolhimento_abrigo">9. Serviço de Acolhimento na modalidade Abrigo Institucional</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="acolhimento_casa_lar" name="tipoServico" value="9. Serviço de Acolhimento na modalidade Casa-Lar">
                            <label for="acolhimento_casa_lar">9. Serviço de Acolhimento na modalidade Casa-Lar</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="acolhimento_casa_passagem" name="tipoServico" value="9. Serviço de Acolhimento na modalidade Casa de Passagem">
                            <label for="acolhimento_casa_passagem">9. Serviço de Acolhimento na modalidade Casa de Passagem</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="acolhimento_residencia" name="tipoServico" value="9. Serviço de Acolhimento na modalidade Residência Inclusiva">
                            <label for="acolhimento_residencia">9. Serviço de Acolhimento na modalidade Residência Inclusiva</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="acolhimento_republica" name="tipoServico" value="9. Serviço de Acolhimento na modalidade República">
                            <label for="acolhimento_republica">9. Serviço de Acolhimento na modalidade República</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="acolhimento_familia" name="tipoServico" value="9. Serviço de Acolhimento na modalidade Família Acolhedora">
                            <label for="acolhimento_familia">9. Serviço de Acolhimento na modalidade Família Acolhedora</label>
                        </div>
                    </div>
                </div>

                <!-- 1. DOCUMENTOS DISPONIBILIZADOS -->
                <div class="form-section">
                    <h3>📄 1. DOCUMENTOS DISPONIBILIZADOS:</h3>
                    <div class="form-group">
                        <label for="pareceres_tecnicos">Parecer(s) Técnico(s) nº:</label>
                        <input type="text" id="pareceres_tecnicos" name="pareceres_tecnicos">
                    </div>
                    <div class="form-group">
                        <label for="notas_tecnicas">Nota(s) Técnica(s) nº:</label>
                        <input type="text" id="notas_tecnicas" name="notas_tecnicas">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="plano_acao_ano">Plano de Ação Ano:</label>
                            <input type="number" id="plano_acao_ano" name="plano_acao_ano" min="2020" max="2030">
                        </div>
                        <div class="form-group">
                            <label for="relatorio_atividades_ano">Relatório de Atividades Ano:</label>
                            <input type="number" id="relatorio_atividades_ano" name="relatorio_atividades_ano" min="2020" max="2030">
                        </div>
                    </div>
                </div>

                <!-- 2. DA VISITA -->
                <div class="form-section">
                    <h3>🏢 2. DA VISITA</h3>
                    
                    <!-- NOVOS CAMPOS: Nome da Entidade e CNPJ -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome_entidade">Nome da Entidade Visitada:</label>
                            <input type="text" id="nome_entidade" name="nome_entidade" required>
                        </div>
                        <div class="form-group">
                            <label for="cnpj_entidade">CNPJ:</label>
                            <input type="text" id="cnpj_entidade" name="cnpj_entidade" placeholder="00.000.000/0000-00" maxlength="18" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data_visita">2.1. Data:</label>
                            <input type="date" id="data_visita" name="data_visita" required>
                        </div>
                        <div class="form-group">
                            <label>2.2. Horário:</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="horario_visita" value="matutino">
                                    matutino
                                </label>
                                <label>
                                    <input type="radio" name="horario_visita" value="vespertino">
                                    vespertino
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome_recebeu">2.3. Nome de quem recebeu o conselheiro na instituição:</label>
                            <input type="text" id="nome_recebeu" name="nome_recebeu" required>
                        </div>
                        <div class="form-group">
                            <label for="funcao_recebeu">Função:</label>
                            <input type="text" id="funcao_recebeu" name="funcao_recebeu" required>
                        </div>
                    </div>

                    <!-- 2.4. Endereço(s) visitado(s) -->
                    <div class="form-group">
                        <label>2.4. Endereço(s) visitado(s):</label>
                        <div id="enderecosContainer">
                            <div class="endereco-item">
                                <span style="font-weight: 600;">1:</span>
                                <input type="text" name="endereco_1" placeholder="Digite o endereço visitado" style="flex: 1;">
                                <label style="margin: 0;">
                                    <input type="radio" name="licenca_1" value="sim"> Sim
                                </label>
                                <label style="margin: 0;">
                                    <input type="radio" name="licenca_1" value="nao"> Não
                                </label>
                                <span style="font-size: 14px; color: #666;">Licença de Funcionamento</span>
                            </div>
                            <div class="endereco-item">
                                <span style="font-weight: 600;">2:</span>
                                <input type="text" name="endereco_2" placeholder="Digite o endereço visitado" style="flex: 1;">
                                <label style="margin: 0;">
                                    <input type="radio" name="licenca_2" value="sim"> Sim
                                </label>
                                <label style="margin: 0;">
                                    <input type="radio" name="licenca_2" value="nao"> Não
                                </label>
                                <span style="font-size: 14px; color: #666;">Licença de Funcionamento</span>
                            </div>
                            <div class="endereco-item">
                                <span style="font-weight: 600;">3:</span>
                                <input type="text" name="endereco_3" placeholder="Digite o endereço visitado" style="flex: 1;">
                                <label style="margin: 0;">
                                    <input type="radio" name="licenca_3" value="sim"> Sim
                                </label>
                                <label style="margin: 0;">
                                    <input type="radio" name="licenca_3" value="nao"> Não
                                </label>
                                <span style="font-size: 14px; color: #666;">Licença de Funcionamento</span>
                            </div>
                        </div>
                    </div>

                    <!-- 2.5. Público-alvo -->
                    <div class="form-group">
                        <label>2.5. Público-alvo:</label>
                        <div class="table-container">
                            <table class="form-table">
                                <thead>
                                    <tr>
                                        <th>Público</th>
                                        <th>Possui registro no Conselho do Idoso - CDI/DF?</th>
                                        <th>Possui registro no Conselho da Criança e Adolesc - CDCA/DF?</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Pessoas idosas (mais de 60 anos)</td>
                                        <td>
                                            <label><input type="radio" name="cdi_idosos" value="sim"> sim</label>
                                            <label><input type="radio" name="cdi_idosos" value="nao"> não</label>
                                        </td>
                                        <td>não se aplica</td>
                                    </tr>
                                    <tr>
                                        <td>Crianças e adolescentes (até 18 anos)</td>
                                        <td>não se aplica</td>
                                        <td>
                                            <label><input type="radio" name="cdca_criancas" value="sim"> sim</label>
                                            <label><input type="radio" name="cdca_criancas" value="nao"> não</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Famílias</td>
                                        <td>
                                            <label><input type="radio" name="cdi_familias" value="sim"> sim</label>
                                            <label><input type="radio" name="cdi_familias" value="nao"> não</label>
                                        </td>
                                        <td>
                                            <label><input type="radio" name="cdca_familias" value="sim"> sim</label>
                                            <label><input type="radio" name="cdca_familias" value="nao"> não</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Adultos (entre 18 a 59 anos)</td>
                                        <td>não se aplica</td>
                                        <td>não se aplica</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 2.6. Formas de acesso dos usuários -->
                    <div class="form-group">
                        <label>2.6. Formas de acesso dos usuários nos serviços/ações:</label>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="procura_espontanea" name="formasAcesso" value="Procura espontânea">
                                <label for="procura_espontanea">Procura espontânea</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="busca_ativa" name="formasAcesso" value="Busca ativa">
                                <label for="busca_ativa">Busca ativa</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="enc_secretaria" name="formasAcesso" value="Encaminhamento da Secretaria de Assistência Social do Distrito Federal">
                                <label for="enc_secretaria">Encaminhamento da Secretaria de Assistência Social do Distrito Federal</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="enc_cras" name="formasAcesso" value="Encaminhamento do CRAS">
                                <label for="enc_cras">Encaminhamento do CRAS</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="enc_creas" name="formasAcesso" value="Encaminhamento do CREAS">
                                <label for="enc_creas">Encaminhamento do CREAS</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="enc_conselhos" name="formasAcesso" value="Encaminhamento de Conselhos de Defesa de Direitos">
                                <label for="enc_conselhos">Encaminhamento de Conselhos de Defesa de Direitos</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="enc_politicas" name="formasAcesso" value="Encaminhamento pelas demais políticas públicas">
                                <label for="enc_politicas">Encaminhamento pelas demais políticas públicas</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="det_judicial" name="formasAcesso" value="Por determinação judicial">
                                <label for="det_judicial">Por determinação judicial</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="outras_formas">Outros:</label>
                            <input type="text" id="outras_formas" name="outras_formas" placeholder="Especifique outras formas de acesso">
                        </div>
                    </div>

                    <!-- 2.7. Equipe de profissionais -->
                    <div class="form-group">
                        <label>2.7. Equipe de profissionais:</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="num_voluntarios">Nº de voluntários:</label>
                                <input type="number" id="num_contratados" name="num_contratados" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- 2.8. Especialidades -->
                    <div class="form-group">
                        <label>2.8. Especialidades que atuam na oferta socioassistencial em análise:</label>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="assistente_social" name="especialidades" value="assistente social">
                                <label for="assistente_social">assistente social</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="psicologo" name="especialidades" value="psicólogo">
                                <label for="psicologo">psicólogo</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="pedagogo" name="especialidades" value="pedagogo">
                                <label for="pedagogo">pedagogo</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="terapeuta" name="especialidades" value="terapeuta ocupacional">
                                <label for="terapeuta">terapeuta ocupacional</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="prof_direito" name="especialidades" value="profissional do direito">
                                <label for="prof_direito">profissional do direito</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cuidador" name="especialidades" value="cuidador social (nível médio)">
                                <label for="cuidador">cuidador social (nível médio)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="aux_admin" name="especialidades" value="auxiliar administrativo (nível médio)">
                                <label for="aux_admin">auxiliar administrativo (nível médio)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="agente_social" name="especialidades" value="agente social (nível médio)">
                                <label for="agente_social">agente social (nível médio)</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="outras_especialidades">outros:</label>
                            <input type="text" id="outras_especialidades" name="outras_especialidades" placeholder="Especifique outras especialidades">
                        </div>
                    </div>

                    <!-- 2.9. Infraestrutura -->
                    <div class="form-group">
                        <label>2.9. Infraestrutura:</label>
                        
                        <div class="form-group">
                            <label>a) O Espaço é:</label>
                            <div class="radio-group">
                                <label><input type="radio" name="tipo_espaco" value="próprio"> próprio</label>
                                <label><input type="radio" name="tipo_espaco" value="alugado"> alugado</label>
                                <label><input type="radio" name="tipo_espaco" value="cedido"> cedido</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>b) Atende aos critérios de acessibilidade?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="acessibilidade" value="sim"> sim</label>
                                <label><input type="radio" name="acessibilidade" value="nao"> não</label>
                            </div>
                            <div class="form-group">
                                <label for="obs_acessibilidade">Observações:</label>
                                <textarea id="obs_acessibilidade" name="obs_acessibilidade" rows="3"></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>c) Compartilha o espaço com outros serviços?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="compartilha_espaco" value="sim"> sim</label>
                                <label><input type="radio" name="compartilha_espaco" value="nao"> não</label>
                            </div>
                            <div class="form-group">
                                <label for="obs_compartilhamento">Observações:</label>
                                <textarea id="obs_compartilhamento" name="obs_compartilhamento" rows="3"></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>d) O espaço atende de forma satisfatória a execução da oferta socioassistencial?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="espaco_satisfatorio" value="sim"> sim</label>
                                <label><input type="radio" name="espaco_satisfatorio" value="nao"> não</label>
                            </div>
                            <div class="form-group">
                                <label for="obs_espaco">Observações:</label>
                                <textarea id="obs_espaco" name="obs_espaco" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 2.10. Do caráter contínuo e permanente -->
                    <div class="form-group">
                        <label>2.10. Do caráter contínuo e permanente:</label>
                        
                        <div class="form-group">
                            <label>a) Possui atividades de Dezembro a Dezembro?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="atividades_continuas" value="sim"> sim</label>
                                <label><input type="radio" name="atividades_continuas" value="nao"> não</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>b) Possui recesso/férias coletivas?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="recesso_ferias" value="sim"> sim</label>
                                <label><input type="radio" name="recesso_ferias" value="nao"> não</label>
                            </div>
                        </div>
                    </div>

                    <!-- 2.11. Ações gratuitas -->
                    <div class="form-group">
                        <label>2.11. As ações ofertadas são totalmente gratuitas?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="acoes_gratuitas" value="sim"> sim</label>
                            <label><input type="radio" name="acoes_gratuitas" value="nao"> não</label>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="especificar_nao_gratuitas">Se não, especifique:</label>
                                <input type="text" id="especificar_nao_gratuitas" name="especificar_nao_gratuitas">
                            </div>
                            <div class="form-group">
                                <label for="especificar_bpc">Recebe BPC. Especifique:</label>
                                <input type="text" id="especificar_bpc" name="especificar_bpc">
                            </div>
                        </div>
                    </div>

                    <!-- 2.12. Articulação com a rede -->
                    <div class="form-group">
                        <label>2.12. Articulação com a rede setorial SUAS e outras redes:</label>
                        
                        <div style="margin: 20px 0;">
                            <div class="articulacao-grid articulacao-header">
                                <div>Tipo de Rede</div>
                                <div>Sim</div>
                                <div>Não</div>
                                <div>Observações</div>
                            </div>
                            
                            <div class="articulacao-grid">
                                <div>CRAS</div>
                                <div><input type="radio" name="articulacao_cras" value="sim"></div>
                                <div><input type="radio" name="articulacao_cras" value="nao"></div>
                                <div><input type="text" name="obs_cras" placeholder="Observações"></div>
                            </div>
                            
                            <div class="articulacao-grid">
                                <div>CREAS</div>
                                <div><input type="radio" name="articulacao_creas" value="sim"></div>
                                <div><input type="radio" name="articulacao_creas" value="nao"></div>
                                <div><input type="text" name="obs_creas" placeholder="Observações"></div>
                            </div>
                            
                            <div class="articulacao-grid">
                                <div>Saúde</div>
                                <div><input type="radio" name="articulacao_saude" value="sim"></div>
                                <div><input type="radio" name="articulacao_saude" value="nao"></div>
                                <div><input type="text" name="obs_saude" placeholder="Observações"></div>
                            </div>
                            
                            <div class="articulacao-grid">
                                <div>Educação</div>
                                <div><input type="radio" name="articulacao_educacao" value="sim"></div>
                                <div><input type="radio" name="articulacao_educacao" value="nao"></div>
                                <div><input type="text" name="obs_educacao" placeholder="Observações"></div>
                            </div>
                            
                            <div class="articulacao-grid">
                                <div>Habitação</div>
                                <div><input type="radio" name="articulacao_habitacao" value="sim"></div>
                                <div><input type="radio" name="articulacao_habitacao" value="nao"></div>
                                <div><input type="text" name="obs_habitacao" placeholder="Observações"></div>
                            </div>
                            
                            <div class="articulacao-grid">
                                <div>Trabalho e Renda</div>
                                <div><input type="radio" name="articulacao_trabalho" value="sim"></div>
                                <div><input type="radio" name="articulacao_trabalho" value="nao"></div>
                                <div><input type="text" name="obs_trabalho" placeholder="Observações"></div>
                            </div>
                            
                            <div class="articulacao-grid">
                                <div>Sistema de Justiça</div>
                                <div><input type="radio" name="articulacao_justica" value="sim"></div>
                                <div><input type="radio" name="articulacao_justica" value="nao"></div>
                                <div><input type="text" name="obs_justica" placeholder="Observações"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2.13. Correspondência das ações -->
                    <div class="form-group">
                        <label>2.13. As ações efetivamente executadas correspondem à oferta para a qual possui inscrição?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="acoes_correspondem" value="sim"> sim</label>
                            <label><input type="radio" name="acoes_correspondem" value="nao"> não</label>
                        </div>
                        <div class="form-group">
                            <label for="obs_acoes_correspondem">Observações:</label>
                            <textarea id="obs_acoes_correspondem" name="obs_acoes_correspondem" rows="8"></textarea>
                        </div>
                    </div>

                    <!-- 2.14. Metodologia -->
                    <div class="form-group">
                        <label>2.14. A forma de execução (metodologia) das ações atende às diretrizes das regulamentações?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="metodologia_adequada" value="sim"> sim</label>
                            <label><input type="radio" name="metodologia_adequada" value="nao"> não</label>
                        </div>
                        <div class="form-group">
                            <label for="obs_metodologia">Observações:</label>
                            <textarea id="obs_metodologia" name="obs_metodologia" rows="4"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 3. DO VOTO -->
                <div class="form-section">
                    <h3>⚖️ 3. DO VOTO</h3>
                    
                    <div class="form-group">
                        <label>3.1. Quanto às análises técnicas elaboradas pela Secretaria Executiva, o Relator:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="concordancia_analises" value="concorda"> concorda</label>
                            <label><input type="radio" name="concordancia_analises" value="discorda"> discorda</label>
                        </div>
                        <div class="form-group">
                            <label for="fundamentos_discordancia">Fundamentos (se discorda):</label>
                            <textarea id="fundamentos_discordancia" name="fundamentos_discordancia" rows="4"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>3.2. O(A) Conselheiro(a) vota pelo(a):</label>
                        <div style="margin: 15px 0;">
                            <div style="margin-bottom: 10px;">
                                <label><input type="radio" name="voto_final" value="Indeferimento do pedido quanto à oferta analisada"> Indeferimento do pedido quanto à oferta analisada</label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label><input type="radio" name="voto_final" value="Deferimento do pedido quanto à oferta analisada"> Deferimento do pedido quanto à oferta analisada</label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label><input type="radio" name="voto_final" value="Manutenção da inscrição quanto à oferta analisada"> Manutenção da inscrição quanto à oferta analisada</label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label><input type="radio" name="voto_final" value="Cancelamento da inscrição quanto à oferta analisada"> Cancelamento da inscrição quanto à oferta analisada</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="data_voto">Data do voto:</label>
                            <input type="date" id="data_voto" name="data_voto">
                        </div>
                        <div class="form-group">
                            <label for="nome_conselheiro">Conselheiro(a):</label>
                            <input type="text" id="nome_conselheiro" name="nome_conselheiro" required>
                        </div>
                    </div>
                </div>

                <!-- 4. DECLARAÇÃO DE RESPONSABILIDADE -->
                <div class="form-section" style="border: 3px solid #f56565; background: #fef5e7;">
                    <h3 style="color: #c53030;">🔒 4. DECLARAÇÃO DE RESPONSABILIDADE</h3>
                    
                    <div class="form-group" style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <div style="border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; background: #f7fafc;">
                            <p style="font-size: 14px; line-height: 1.6; margin-bottom: 15px; text-align: justify;">
                                <strong>DECLARAÇÃO:</strong> Eu, abaixo assinado(a), na qualidade de Conselheiro(a) do Conselho de Assistência Social do Distrito Federal (CAS-DF), declaro para os devidos fins que:
                            </p>
                            <ul style="font-size: 14px; line-height: 1.6; margin: 15px 0; padding-left: 30px;">
                                <li>Todas as informações prestadas neste relatório de fiscalização são <strong>verdadeiras e fidedignas</strong>;</li>
                                <li>A visita de fiscalização foi realizada de acordo com as <strong>normas e procedimentos</strong> estabelecidos pelo CAS-DF;</li>
                                <li>As observações e avaliações constantes neste documento refletem a <strong>realidade observada in loco</strong>;</li>
                                <li>Estou ciente das <strong>responsabilidades legais</strong> decorrentes desta declaração;</li>
                                <li>O presente relatório foi elaborado com <strong>imparcialidade e independência</strong>, sem conflito de interesses.</li>
                            </ul>
                            <p style="font-size: 14px; line-height: 1.6; margin-top: 15px; text-align: justify;">
                                Declaro ainda estar ciente de que as informações aqui prestadas estão sujeitas às penalidades previstas no Art. 299 do Código Penal (falsidade ideológica), caso sejam inverídicas.
                            </p>
                        </div>
                        
                        <div style="margin: 20px 0; padding: 15px; background: #e6fffa; border-left: 4px solid #38a169; border-radius: 5px;">
                            <label style="display: flex; align-items: center; font-weight: 600; color: #2d3748;">
                                <input type="checkbox" id="declaracao_veracidade" name="declaracao_veracidade" required style="margin-right: 15px; transform: scale(1.5);">
                                <span>CONFIRMO que li, compreendi e concordo integralmente com a declaração acima, assumindo total responsabilidade pelas informações prestadas neste relatório de fiscalização.</span>
                            </label>
                        </div>
                    </div>

                    <!-- Assinatura Digital Aprimorada -->
                    <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #4299e1;">
                        <h4 style="color: #2b6cb0; margin-bottom: 20px;">🔐 ASSINATURA DIGITAL OFICIAL</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cpf_conselheiro">CPF do Conselheiro (somente números):</label>
                                <input type="text" id="cpf_conselheiro" name="cpf_conselheiro" placeholder="000.000.000-00" maxlength="14" required>
                            </div>
                            <div class="form-group">
                                <label for="senha_assinatura">Senha de Confirmação:</label>
                                <input type="password" id="senha_assinatura" name="senha_assinatura" placeholder="Digite sua senha pessoal" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; margin: 15px 0;">
                                <input type="checkbox" id="confirma_assinatura" name="confirma_assinatura" required style="margin-right: 10px; transform: scale(1.3);">
                                <span style="font-weight: 600;">Confirmo minha identidade e autorizo a assinatura digital deste documento</span>
                            </label>
                        </div>
                        
                        <button type="button" onclick="assinarDigitalmente()" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px; margin-top: 10px;">
                            🔒 ASSINAR DOCUMENTO DIGITALMENTE
                        </button>
                        
                        <div id="signatureInfo" style="display: none; margin-top: 20px; padding: 20px; background: #f0fff4; border: 2px solid #48bb78; border-radius: 10px;">
                            <h5 style="color: #38a169; margin-bottom: 15px;">✅ DOCUMENTO ASSINADO DIGITALMENTE</h5>
                            <div style="font-size: 14px; line-height: 1.6;">
                                <p><strong>Conselheiro:</strong> <span id="signatoryName"></span></p>
                                <p><strong>CPF:</strong> <span id="signatoryCPF"></span></p>
                                <p><strong>Data/Hora:</strong> <span id="signatureDateTime"></span></p>
                                <p><strong>Hash de Verificação:</strong> <span id="verificationHash" style="font-family: monospace; background: #e2e8f0; padding: 5px;"></span></p>
                                <p><strong>Status:</strong> <span style="color: #38a169; font-weight: bold;">VÁLIDA</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="salvarRascunho()">💾 Salvar Rascunho</button>
                    <button type="button" class="btn btn-secondary" onclick="carregarRascunho()">📂 Carregar Rascunho</button>
                    <button type="button" class="btn btn-secondary" onclick="validarFormulario()">✅ Validar</button>
                    <button type="button" class="btn btn-primary" onclick="gerarRelatorio()" id="btnRelatorio" disabled>📄 Gerar Relatório</button>
                    <button type="button" class="btn btn-primary" onclick="exportarHTML()">📥 Exportar HTML</button>
                    <button type="button" class="btn btn-danger" onclick="limparFormulario()">🗑️ Limpar Tudo</button>
                </div>
            </form>

            <!-- Seção do Relatório -->
            <div id="reportSection" style="display: none; margin-top: 40px; padding: 30px; background: #f7fafc; border-radius: 15px;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2>📋 FICHA DE RELATO DE FISCALIZAÇÃO</h2>
                    <p><strong>CONSELHO DE ASSISTÊNCIA SOCIAL DO DISTRITO FEDERAL</strong></p>
                    <p>SEPN Quadra 515 Lote 02 Bloco B, 4º andar - Asa Norte/DF - CEP 70.770-502</p>
                    <p>E-mail: Cas_df@sedes.df.gov.br</p>
                </div>
                
                <div id="reportContent"></div>

                <div class="action-buttons" style="margin-top: 30px;">
                    <button onclick="voltarFormulario()" class="btn btn-secondary">⬅️ Voltar</button>
                    <button onclick="imprimirRelatorio()" class="btn btn-primary">🖨️ Imprimir PDF</button>
                    <button onclick="gerarPDF()" class="btn btn-primary">📄 Baixar PDF</button>
                    <button onclick="enviarEmail()" class="btn btn-success">📧 Enviar Email</button>
                    <button onclick="salvarRelatorio()" class="btn btn-secondary">💾 Backup HTML</button>
                    <button onclick="verificarDocumento()" class="btn btn-secondary">🔍 Verificar Hash</button>
                </div>

                <!-- Modal de Email -->
                <div id="emailModal" class="modal">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="fecharEmailModal()">&times;</span>
                        <h3>📧 Enviar Relatório por Email</h3>
                        
                        <div class="form-group">
                            <label for="email_destinatario">Para (destinatário):</label>
                            <input type="email" id="email_destinatario" value="Cas_df@sedes.df.gov.br" style="width: 100%;">
                        </div>
                        
                        <div class="form-group">
                            <label for="email_copia">Com cópia (CC):</label>
                            <input type="email" id="email_copia" placeholder="seu.email@exemplo.com" style="width: 100%;">
                        </div>
                        
                        <div class="form-group">
                            <label for="email_assunto">Assunto:</label>
                            <input type="text" id="email_assunto" style="width: 100%;" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="email_corpo">Mensagem:</label>
                            <textarea id="email_corpo" rows="12" style="width: 100%;" readonly></textarea>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #e6fffa; border-radius: 5px; border-left: 4px solid #38a169;">
                            <p style="margin: 0; font-size: 14px;"><strong>📎 Anexo:</strong> O relatório em PDF será anexado automaticamente</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Documento: <span id="nome_arquivo_email"></span></p>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                            <button onclick="abrirClienteEmail()" class="btn btn-primary">📧 Abrir no Email</button>
                            <button onclick="copiarTextoEmail()" class="btn btn-secondary">📋 Copiar Texto</button>
                            <button onclick="fecharEmailModal()" class="btn btn-secondary">❌ Cancelar</button>
                        </div>
                    </div>
                </div>

                <!-- Modal de Verificação -->
                <div id="verificacaoModal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="fecharVerificacaoModal()">&times;</span>
                        <h3>🔍 Verificação de Autenticidade</h3>
                        
                        <div style="text-align: center; margin: 20px 0;">
                            <div id="qrcode" style="display: inline-block; padding: 20px; background: white; border: 2px solid #e2e8f0; border-radius: 10px;"></div>
                        </div>
                        
                        <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h4 style="color: #2d3748; margin-bottom: 15px;">📋 Dados de Verificação:</h4>
                            <p><strong>Número do Documento:</strong> <span id="numero_documento_verify"></span></p>
                            <p><strong>Hash de Verificação:</strong> <br><code id="hash_documento_verify" style="background: #e2e8f0; padding: 5px; font-family: monospace; word-break: break-all;"></code></p>
                            <p><strong>Data/Hora de Assinatura:</strong> <span id="timestamp_verify"></span></p>
                            <p><strong>Conselheiro:</strong> <span id="conselheiro_verify"></span></p>
                            <p><strong>CPF:</strong> <span id="cpf_verify"></span></p>
                        </div>
                        
                        <div style="background: #f0fff4; border: 2px solid #48bb78; padding: 15px; border-radius: 10px; text-align: center;">
                            <h4 style="color: #38a169; margin: 0;">✅ DOCUMENTO AUTÊNTICO</h4>
                            <p style="margin: 5px 0 0 0; font-size: 14px;">Este documento possui assinatura digital válida</p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="fecharVerificacaoModal()" class="btn btn-primary">✅ OK</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Área de Notificações -->
    <div id="notification" class="notification"></div>

    <script>
        // Variáveis globais
        let assinaturaValida = false;
        let hashDocumento = '';
        let numeroDocumento = '';
        let dadosRelatorio = {};

        // Inicialização segura
        function inicializar() {
            try {
                const hoje = new Date().toISOString().split('T')[0];
                const dataVisitaEl = document.getElementById('data_visita');
                const dataVotoEl = document.getElementById('data_voto');
                
                if (dataVisitaEl) dataVisitaEl.value = hoje;
                if (dataVotoEl) dataVotoEl.value = hoje;
                
                aplicarMascaras();
                monitorarValidacoes();
                gerarNumeroDocumento();
                
                mostrarNotificacao('Sistema carregado com sucesso!', 'success', 2000);
            } catch (error) {
                console.error('Erro na inicialização:', error);
                mostrarNotificacao('num_voluntarios" name="num_voluntarios" min="0">
                            </div>
                            <div class="form-group">
                                <label for="num_contratados">Nº de contratados:</label>
                                <input type="number" id="
